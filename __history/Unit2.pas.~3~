unit Unit2;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes,
  Vcl.Graphics, Vcl.Controls, Vcl.Forms, Vcl.Dialogs, Vcl.ExtCtrls, Math, Vcl.StdCtrls;

type
  TForm2 = class(TForm)
    Panel1: TPanel;
    procedure FormCreate(Sender: TObject);
  private
    lastDoubleStepRow, lastDoubleStepCol: Integer;
    BoardPanels: array[0..7, 0..7] of TPanel;
    selectedRow, selectedCol: Integer;
    selected: Boolean;
    promotionSelection: Integer;
    currentPlayer: Char; // 'w' = biały, 'b' = czarny
    procedure CreateBoard;
    procedure PanelClick(Sender: TObject);
    procedure UpdateBoardColors;
    function IsPlayersPiece(const figura: string): Boolean;
    function CanMoveLikeRook(startRow, startCol, endRow, endCol: Integer): Boolean;
    function CanMoveLikeBishop(startRow, startCol, endRow, endCol: Integer): Boolean;
    function PromotePawn(player: Char): string;
    procedure PromoButtonClick(Sender: TObject);
    function PromotePawnDialog(player: Char): string;





  public
  end;

var
  Form2: TForm2;

implementation

{$R *.dfm}

procedure TForm2.FormCreate(Sender: TObject);
begin
  CreateBoard;
  currentPlayer := 'w';
  lastDoubleStepRow := -1;
  lastDoubleStepCol := -1;
end;

procedure TForm2.CreateBoard;
const
  FiguryBiale: array[0..7] of string = ('♖', '♘', '♗', '♕', '♔', '♗', '♘', '♖');
  FiguryCzarne: array[0..7] of string = ('♜', '♞', '♝', '♛', '♚', '♝', '♞', '♜');
var
  i, j: Integer;
  square: TPanel;
  size: Integer;
begin
  size := 60;
  Panel1.Left := 250;
  Panel1.Top := 125;
  Panel1.Width := size * 8;
  Panel1.Height := size * 8;
  Panel1.Caption := '';

  for i := 0 to 7 do
    for j := 0 to 7 do
    begin
      square := TPanel.Create(Self);
      square.Parent := Panel1;
      square.Width := size;
      square.Height := size;
      square.Left := j * size;
      square.Top := i * size;
      square.BevelOuter := bvNone;
      square.Tag := i * 8 + j;
      square.OnClick := PanelClick;
      square.Alignment := taCenter;
      square.Font.Size := 24;
      square.Caption := '';
      square.ParentBackground := False;

      if (i + j) mod 2 = 0 then
        square.Color := RGB(198,169,115)
      else
        square.Color := RGB(118,79,43);

      if i = 0 then square.Caption := FiguryCzarne[j];
      if i = 1 then square.Caption := '♟';
      if i = 6 then square.Caption := '♙';
      if i = 7 then square.Caption := FiguryBiale[j];

      BoardPanels[i, j] := square;
    end;
end;

function TForm2.CanMoveLikeRook(startRow, startCol, endRow, endCol: Integer): Boolean;
var
  i: Integer;
begin
  Result := False;
  if startRow = endRow then
  begin
    for i := Min(startCol, endCol) + 1 to Max(startCol, endCol) - 1 do
      if BoardPanels[startRow, i].Caption <> '' then Exit;
    Result := True;
  end
  else if startCol = endCol then
  begin
    for i := Min(startRow, endRow) + 1 to Max(startRow, endRow) - 1 do
      if BoardPanels[i, startCol].Caption <> '' then Exit;
    Result := True;
  end;
end;

function TForm2.CanMoveLikeBishop(startRow, startCol, endRow, endCol: Integer): Boolean;
var
  i, rowStep, colStep: Integer;
  r, c: Integer;
begin
  Result := False;
  if Abs(startRow - endRow) <> Abs(startCol - endCol) then Exit;

  rowStep := Sign(endRow - startRow);
  colStep := Sign(endCol - startCol);
  r := startRow + rowStep;
  c := startCol + colStep;

  while (r <> endRow) and (c <> endCol) do
  begin
    if BoardPanels[r, c].Caption <> '' then Exit;
    Inc(r, rowStep);
    Inc(c, colStep);
  end;

  Result := True;
end;



procedure TForm2.PromoButtonClick(Sender: TObject);
var
  btn: TButton;
begin
  btn := Sender as TButton;
  promotionSelection := btn.Tag;
  (btn.Parent as TForm).ModalResult := mrOk;
end;

function TForm2.PromotePawnDialog(player: Char): string;
const
  // kolejność: Hetman, Wieża, Goniec, Skoczek
  WhitePieces: array[0..3] of string = ('♕','♖','♗','♘');
  BlackPieces: array[0..3] of string = ('♛','♜','♝','♞');
var
  dlg: TForm;
  btn: TButton;
  i, btnWidth: Integer;
  arr: array of string;
begin
  // wybierz tablicę figur
  if player = 'w' then
  begin
    SetLength(arr, Length(WhitePieces));
    for i := 0 to High(WhitePieces) do arr[i] := WhitePieces[i];
  end
  else
  begin
    SetLength(arr, Length(BlackPieces));
    for i := 0 to High(BlackPieces) do arr[i] := BlackPieces[i];
  end;

  // utwórz dialog
  dlg := TForm.Create(nil);
  try
    dlg.Caption := 'Promocja pionka';
    dlg.BorderStyle := bsDialog;
    dlg.Position := poScreenCenter;
    dlg.ClientWidth := 100 * Length(arr) + 20;
    dlg.ClientHeight := 100;

    promotionSelection := 0; // domyślne: hetman
    btnWidth := (dlg.ClientWidth - 20) div Length(arr);

    for i := 0 to High(arr) do
    begin
      btn := TButton.Create(dlg);
      btn.Parent := dlg;
      btn.Caption := arr[i];
      btn.SetBounds(10 + i * btnWidth, 10, btnWidth - 5, 40);
      btn.Tag := i;
      btn.OnClick := PromoButtonClick;
    end;

    if dlg.ShowModal = mrOk then
      Result := arr[promotionSelection]
    else
      Result := arr[0]; // hetman jako domyślna
  finally
    dlg.Free;
  end;
end;































procedure TForm2.PanelClick(Sender: TObject);
var
  square: TPanel;
  row, col, i: Integer;
  piece: string;
begin
  square := Sender as TPanel;
  row := square.Tag div 8;
  col := square.Tag mod 8;

  if not selected then
  begin
    piece := BoardPanels[row, col].Caption;
    if (piece <> '') and IsPlayersPiece(piece) then
    begin
      selectedRow := row;
      selectedCol := col;
      selected := True;
      BoardPanels[row, col].Color := clLime;
    end;
  end
  else
  begin
    piece := BoardPanels[selectedRow, selectedCol].Caption;

       // White pawn
     if piece = '♙' then
begin
  // ruch o 1 pole
  if (row = selectedRow - 1) and (col = selectedCol) and (BoardPanels[row, col].Caption = '') then
  begin
    if row = 0 then
  BoardPanels[row, col].Caption := PromotePawnDialog('w')
else
  BoardPanels[row, col].Caption := '♙';
    BoardPanels[selectedRow, selectedCol].Caption := '';
    currentPlayer := 'b';
    lastDoubleStepRow := -1; lastDoubleStepCol := -1;
  end

  // ruch o 2 pola
  else if (selectedRow = 6) and (row = 4) and (col = selectedCol)
       and (BoardPanels[5, col].Caption = '') and (BoardPanels[row, col].Caption = '') then
  begin
    BoardPanels[row, col].Caption := '♙';
    BoardPanels[selectedRow, selectedCol].Caption := '';
    currentPlayer := 'b';
    lastDoubleStepRow := selectedRow; lastDoubleStepCol := selectedCol;
  end

  // en passant
  else if (selectedRow = 3) and (row = 2) and (Abs(col - selectedCol) = 1)
       and (lastDoubleStepRow = 1) and (lastDoubleStepCol = col)
       and (BoardPanels[selectedRow, col].Caption = '♟') then
  begin
    if row = 0 then
  BoardPanels[row, col].Caption := PromotePawnDialog('w')
    else
  BoardPanels[row, col].Caption := '♙';
    BoardPanels[selectedRow, selectedCol].Caption := '';
    BoardPanels[selectedRow, col].Caption := '';
    currentPlayer := 'b';
    lastDoubleStepRow := -1; lastDoubleStepCol := -1;
  end

  // bicie na ukos
  else if (row = selectedRow-1) and (Abs(col-selectedCol)=1)
    and (BoardPanels[row,col].Caption <> '')
    and not IsPlayersPiece(BoardPanels[row,col].Caption) then
  begin
    if row = 0 then
  BoardPanels[row, col].Caption := PromotePawnDialog('w')
    else
  BoardPanels[row, col].Caption := '♙';
    BoardPanels[selectedRow, selectedCol].Caption := '';
    currentPlayer := 'b';
    lastDoubleStepRow := -1; lastDoubleStepCol := -1;
  end

  else Exit;
  end









  else if piece = '♟' then
begin
  // 1 pole ruchu
  if (row = selectedRow + 1) and (col = selectedCol) and (BoardPanels[row, col].Caption = '') then
  begin
    if row = 7 then
      BoardPanels[row, col].Caption := PromotePawnDialog('b')
    else
      BoardPanels[row, col].Caption := piece;

    BoardPanels[selectedRow, selectedCol].Caption := '';
    currentPlayer := 'w';
    lastDoubleStepRow := -1;
    lastDoubleStepCol := -1;
  end

  // 2 pola
  else if (selectedRow = 1) and (row = 3) and (col = selectedCol)
       and (BoardPanels[2, col].Caption = '') and (BoardPanels[row, col].Caption = '') then
  begin
    BoardPanels[row, col].Caption := piece;
    BoardPanels[selectedRow, selectedCol].Caption := '';
    currentPlayer := 'w';
    lastDoubleStepRow := selectedRow;
    lastDoubleStepCol := selectedCol;
  end

  // en passant
  else if (selectedRow = 4) and (row = 5) and (Abs(col - selectedCol) = 1)
       and (lastDoubleStepRow = 6) and (lastDoubleStepCol = col)
       and (BoardPanels[selectedRow, col].Caption = '♙') then
  begin
    if row = 7 then
      BoardPanels[row, col].Caption := PromotePawnDialog('b')
    else
      BoardPanels[row, col].Caption := piece;

    BoardPanels[selectedRow, selectedCol].Caption := '';
    BoardPanels[selectedRow, col].Caption := '';
    currentPlayer := 'w';
    lastDoubleStepRow := -1;
    lastDoubleStepCol := -1;
  end

  // bicie na skos
  else if (row = selectedRow + 1) and (Abs(col - selectedCol) = 1)
       and (BoardPanels[row, col].Caption <> '')
       and not IsPlayersPiece(BoardPanels[row, col].Caption) then
  begin
    if row = 7 then
      BoardPanels[row, col].Caption := PromotePawnDialog('b')
    else
      BoardPanels[row, col].Caption := piece;

    BoardPanels[selectedRow, selectedCol].Caption := '';
    currentPlayer := 'w';
    lastDoubleStepRow := -1;
    lastDoubleStepCol := -1;
  end


      else Exit;
    end

    // SKOCZEK
    else if (piece = '♘') or (piece = '♞') then
    begin
      if (((Abs(row - selectedRow) = 2) and (Abs(col - selectedCol) = 1)) or
          ((Abs(row - selectedRow) = 1) and (Abs(col - selectedCol) = 2))) and
         ((BoardPanels[row, col].Caption = '') or not IsPlayersPiece(BoardPanels[row, col].Caption)) then
      begin
        BoardPanels[row, col].Caption := piece;
        BoardPanels[selectedRow, selectedCol].Caption := '';
        if currentPlayer = 'w' then currentPlayer := 'b' else currentPlayer := 'w';
        lastDoubleStepRow := -1; lastDoubleStepCol := -1;
      end
      else Exit;
    end

    // WIEŻA
    else if (piece = '♖') or (piece = '♜') then
    begin
      if not CanMoveLikeRook(selectedRow, selectedCol, row, col) then Exit;
      if (BoardPanels[row, col].Caption <> '') and IsPlayersPiece(BoardPanels[row, col].Caption) then Exit;

      BoardPanels[row, col].Caption := piece;
      BoardPanels[selectedRow, selectedCol].Caption := '';
      if currentPlayer = 'w' then currentPlayer := 'b' else currentPlayer := 'w';
      lastDoubleStepRow := -1; lastDoubleStepCol := -1;
    end

    // GONIEC
    else if (piece = '♗') or (piece = '♝') then
    begin
      if not CanMoveLikeBishop(selectedRow, selectedCol, row, col) then Exit;
      if (BoardPanels[row, col].Caption <> '') and IsPlayersPiece(BoardPanels[row, col].Caption) then Exit;

      BoardPanels[row, col].Caption := piece;
      BoardPanels[selectedRow, selectedCol].Caption := '';
      if currentPlayer = 'w' then currentPlayer := 'b' else currentPlayer := 'w';
      lastDoubleStepRow := -1; lastDoubleStepCol := -1;
    end

    // HETMAN
    else if (piece = '♕') or (piece = '♛') then
    begin
      if not (CanMoveLikeRook(selectedRow, selectedCol, row, col) or
              CanMoveLikeBishop(selectedRow, selectedCol, row, col)) then Exit;
      if (BoardPanels[row, col].Caption <> '') and IsPlayersPiece(BoardPanels[row, col].Caption) then Exit;

      BoardPanels[row, col].Caption := piece;
      BoardPanels[selectedRow, selectedCol].Caption := '';
      if currentPlayer = 'w' then currentPlayer := 'b' else currentPlayer := 'w';
      lastDoubleStepRow := -1; lastDoubleStepCol := -1;
    end

    // KRÓL
    else if (piece = '♔') or (piece = '♚') then
    begin
      if (Abs(row - selectedRow) <= 1) and (Abs(col - selectedCol) <= 1) and
         ((BoardPanels[row, col].Caption = '') or not IsPlayersPiece(BoardPanels[row, col].Caption)) then
      begin
        BoardPanels[row, col].Caption := piece;
        BoardPanels[selectedRow, selectedCol].Caption := '';
        if currentPlayer = 'w' then currentPlayer := 'b' else currentPlayer := 'w';
        lastDoubleStepRow := -1; lastDoubleStepCol := -1;
      end
      else Exit;
    end
    else
      Exit;

    selected := False;
    UpdateBoardColors;
  end;
end;

procedure TForm2.UpdateBoardColors;
var
  i, j: Integer;
begin
  for i := 0 to 7 do
    for j := 0 to 7 do
    begin
      if (i + j) mod 2 = 0 then
        BoardPanels[i, j].Color := RGB(198,169,115)
      else
        BoardPanels[i, j].Color := RGB(118,79,43);
    end;
end;

function TForm2.IsPlayersPiece(const figura: string): Boolean;
const
  BialeFigury: array[0..5] of string = ('♙', '♖', '♘', '♗', '♕', '♔');
  CzarneFigury: array[0..5] of string = ('♟', '♜', '♞', '♝', '♛', '♚');
var
  idx: Integer;
begin
  Result := False;
  if currentPlayer = 'w' then
  begin
    for idx := 0 to High(BialeFigury) do
      if figura = BialeFigury[idx] then
        Exit(True);
  end
  else
  begin
    for idx := 0 to High(CzarneFigury) do
      if figura = CzarneFigury[idx] then
        Exit(True);
  end;
end;


 function TForm2.PromotePawn(player: Char): string;
var
  choice: Char;
begin
  repeat
    choice := UpCase(InputBox('Promocja pionka', 'Wybierz figurę (Q - Hetman, R - Wieża, B - Goniec, N - Skoczek):', 'Q')[1]);
  until choice in ['Q', 'R', 'B', 'N'];

  if player = 'w' then
    case choice of
      'Q': Result := '♕';
      'R': Result := '♖';
      'B': Result := '♗';
      'N': Result := '♘';
    end
  else
    case choice of
      'Q': Result := '♛';
      'R': Result := '♜';
      'B': Result := '♝';
      'N': Result := '♞';
    end;
end;






end.
